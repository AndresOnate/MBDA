--CICLO 1: Tablas

---usuarios
CREATE TABLE usuarios(
    id NUMBER(5),
    email VARCHAR(100) NOT NULL,
    name VARCHAR(50) NOT NULL,
    createdAt DATE NOT NULL
 );
 
 
 ---likes
CREATE TABLE likes(
    usuarios_id NUMBER(5),
    contenidos_id NUMBER(5)
 );
 
 
 
 ---cuentas
CREATE TABLE cuentas(
    id NUMBER(5),
    name VARCHAR2(70) NOT NULL,
    createdAt DATE NOT NULL,
    suscribers NUMBER(5) NOT NULL,
    usuarios_id NUMBER(5) NOT NULL   
 );
 
 
 ---labels
CREATE TABLE labels(
    exclusividades_id NUMBER(5) NOT NULL,
    exclusividades_order NUMBER(3) NOT NUll,
    label VARCHAR2(10)
 );
 
 
 ---exclusividades
CREATE TABLE exclusividades(
    code VARCHAR2(9) NOT NULL,
    e_order NUMBER(3),
    name VARCHAR2(55) NOT NULL,
    price NUMBER(9),
    duration  NUMBER(2),
    cuentas_id NUMBER(5)
 );
 
 
 
 ---suscripciones
 CREATE TABLE suscripciones(
    id NUMBER(5),
    createdAt DATE NOT NULL,
    detail VARCHAR2(50),
    cuentas_id NUMBER(5) NOT NULL,
    suscritoA NUMBER(5) NOT NULL
 );
 
 
 ---etapas
CREATE TABLE etapas(
    startAt DATE,
    endAt DATE,
    price NUMBER(9) NOT NULL,
    status VARCHAR2(20) NOT NULL,
    exclusividades_id NUMBER(5) NOT NULL,
    suscripciones_id NUMBER(5) NOT NULL,
    exclusividades_order NUMBER(3) NOT NULL
 );
 
 
 
 ---contenidos
 CREATE TABLE contenidos(
    id NUMBER(10) NOT NULL,
    title VARCHAR2(20) NOT NULL,
    publishingDate DATE NOT NULL,
    description VARCHAR(30),
    usuarios_id NUMBER(5) NOT NULL,
    exclusividades_id NUMBER(5) NOT NULL,
    exclusividades_order NUMBER(3) NOT NULL
 );
 
 
 ---videos
CREATE TABLE videos(
    contenidos_id NUMBER(5),
    duration NUMBER(11) NOT NULL
 );
 
 
 ---streamings
CREATE TABLE streamings(
    contenidos_id NUMBER(5),
    plannedDate DATE NOT NULL,
    actualDate DATE,
    duration NUMBER(4)
 );
 
 
 
 ---posts
CREATE TABLE posts(
    contenidos_id NUMBER(5),
    text VARCHAR2(50)
);
 
 
 --CICLO 1: XTablas
 
 --- Primarias
-- usuarios
ALTER TABLE usuarios ADD CONSTRAINT PK_USUARIOS PRIMARY KEY(id);


-- cuentas
ALTER TABLE cuentas ADD  CONSTRAINT PK_CUENTAS PRIMARY KEY(id);


-- suscripciones
ALTER TABLE suscripciones ADD CONSTRAINT PK_SUSCRIPCIONES PRIMARY KEY(id);


--  exclusividades
ALTER TABLE exclusividades ADD CONSTRAINT PK_EXCLUSIVIDADES PRIMARY KEY(e_order, cuentas_id);


-- labels
ALTER TABLE labels ADD CONSTRAINT PK_LABELS PRIMARY KEY(label);  


-- etapas
ALTER TABLE etapas ADD CONSTRAINT PK_ETAPAS PRIMARY KEY(startAt, suscripciones_id);  


-- contenidos
ALTER TABLE contenidos ADD CONSTRAINT PK_CONTENIDOS PRIMARY KEY(id);


-- videos
ALTER TABLE videos ADD CONSTRAINT PK_VIDEOS PRIMARY KEY(contenidos_id); 


-- streaimgs
ALTER TABLE streamings ADD CONSTRAINT PK_STREAMING PRIMARY KEY(contenidos_id);


-- posts
ALTER TABLE posts ADD CONSTRAINT PK_POSTS PRIMARY KEY(contenidos_id);


-- likes
ALTER TABLE likes ADD CONSTRAINT PK_LIKES PRIMARY KEY(usuarios_id, contenidos_id);




--- Unicas
ALTER TABLE usuarios ADD CONSTRAINT UK_USUARIOS_EMAIL UNIQUE(email);



--- Foraneas                    

-- usuarios

-- cuentas
ALTER TABLE cuentas ADD CONSTRAINT FK_CUENTAS_USUARIOS_ID FOREIGN KEY(usuarios_id) REFERENCES usuarios(id);


-- suscripciones
ALTER TABLE suscripciones ADD CONSTRAINT FK_SUSCRIPCIONES_CUENTAS_ID FOREIGN KEY(cuentas_id) REFERENCES cuentas(id);
ALTER TABLE suscripciones ADD CONSTRAINT FK_SUSCRIPCIONES_CUENTAS_SA FOREIGN KEY(suscritoA) REFERENCES cuentas(id);


--  exclusividades
ALTER TABLE exclusividades ADD CONSTRAINT FK_EXCLUSIVIDADES_CUENTAS FOREIGN KEY(cuentas_id) REFERENCES cuentas(id);


-- labels
ALTER TABLE labels ADD CONSTRAINT FK_LABELS_EXCLUSIVIDADES FOREIGN KEY(exclusividades_order, exclusividades_id) REFERENCES exclusividades(e_order,cuentas_id);  


-- etapas
ALTER TABLE etapas ADD CONSTRAINT FK_ETAPAS_SUSCRIPCIONES_ID FOREIGN KEY(suscripciones_id) REFERENCES suscripciones(id);  
ALTER TABLE etapas ADD  CONSTRAINT FK_ETAPAS_EXCLUSIVIDADES_CID FOREIGN KEY(exclusividades_order, exclusividades_id) REFERENCES exclusividades(e_order, cuentas_id); 


-- contenidos
ALTER TABLE contenidos ADD CONSTRAINT FK_CONTENIDOS_USUARIOS_ID FOREIGN KEY(usuarios_id) REFERENCES usuarios(id);
ALTER TABLE contenidos ADD CONSTRAINT FK_CONTENIDOS_EXCLUSIVIDADES FOREIGN KEY(exclusividades_order, exclusividades_id) REFERENCES exclusividades(e_order, cuentas_id);


-- videos
ALTER TABLE videos ADD CONSTRAINT FK_VIDEOS_CONTENIDOS FOREIGN KEY(contenidos_id) REFERENCES contenidos(id); 


-- streaimgs
ALTER TABLE streamings ADD CONSTRAINT FK_STREAMING_CONTENIDOS FOREIGN KEY(contenidos_id) REFERENCES contenidos(id);


-- posts
ALTER TABLE posts ADD CONSTRAINT FK_POSTS_CONTENIDOS FOREIGN KEY(contenidos_id) REFERENCES contenidos(id);


-- likes
ALTER TABLE likes ADD CONSTRAINT FK_LIKES_USUARIOS FOREIGN KEY(usuarios_id) REFERENCES usuarios(id);
ALTER TABLE likes ADD CONSTRAINT FK_LIKES_CONTENIDOS FOREIGN KEY(contenidos_id) REFERENCES contenidos(id);



-- CICLO 1: PoblarOK (1) 

-- usuarios
INSERT INTO usuarios VALUES (1,'andres@gmail.com','Andrés', '04/Mar/2010');
INSERT INTO usuarios VALUES (2,'mateo@gmail.com','Mateo','04/05/2012');
INSERT INTO usuarios VALUES (3,'felipe@gmail.com','Felipe','23/09/2019');

-- cuentas
INSERT INTO cuentas VALUES (9001,'Por si no lo viste', '26/08/2017',0, 1);
INSERT INTO cuentas VALUES (9002,'Auron','12/12/2013',100, 2);
INSERT INTO cuentas VALUES (9003,'Te lo resumo', '14/10/2012',9999, 1);

-- suscripciones
INSERT INTO suscripciones VALUES (4025,'04/03/2022', NULL, 9001, 9002);
INSERT INTO suscripciones VALUES (4026,'13/12/2018', NULL, 9003,9001);
INSERT INTO suscripciones VALUES (4027,'13/12/2014', NULL ,9003,9002);
INSERT INTO suscripciones VALUES (4028,'25/02/2015', NULL ,9002,9002);

-- exclusividades
INSERT INTO exclusividades VALUES ('EX-120510',1, 'Bronce', 5, NULL, 9001);
INSERT INTO exclusividades VALUES ('EX-120611',2, 'Plata', 13, NULL, 9002);
INSERT INTO exclusividades VALUES ('EX-120712',3, 'Oro' ,36, NULL, 9003);

-- labels
INSERT INTO labels VALUES (9001,'No way home');
INSERT INTO labels VALUES (9001,'Euphoria');
INSERT INTO labels VALUES (9001,'Peaky Blinders');

-- etapas
INSERT INTO etapas VALUES ('26/01/2022', NULL, 36, 'Miembro', 9001 , 4026 );
INSERT INTO etapas VALUES ('02/03/2021', NULL, 10, 'Miembro', 9001 , 4025 );
INSERT INTO etapas VALUES ('12/08/2020', NULL, 10, 'Miembro', 9003 , 4027 );


-- contenidos
INSERT INTO contenidos VALUES (45467, 'Resumen Next', '04/03/22' , NULL, 1, 9001);
INSERT INTO contenidos VALUES (45468, 'Critica The Batman', '04/03/22' , NULL, 1, 9001);
INSERT INTO contenidos VALUES (45469, 'Doctor House T1', '09/12/18' , NULL, 2, 9003);
--
INSERT INTO contenidos VALUES (45470, 'FIFA22', '06/03/22' , 'TOTY', 1, 9001);
INSERT INTO contenidos VALUES (45471, 'COFFETV', '03/03/22' , 'Ver peliculas', 1, 9001);
INSERT INTO contenidos VALUES (45472, 'ASMR', '24/08/19' , NULL, 2, 9003);
--
INSERT INTO contenidos VALUES (45473, 'Sitiación del canal', '22/05/17' , NULL, 1, 9002);
INSERT INTO contenidos VALUES (45474, 'Para suscriptores', '21/01/22' , NULL, 1, 9002);
INSERT INTO contenidos VALUES (45475, 'Redes sociales', '26/07/16' , NULL, 2, 9003);

-- videos
INSERT INTO videos VALUES (45467, 10);
INSERT INTO videos VALUES (45468, 8);
INSERT INTO videos VALUES (45469, 15);

-- streamings
INSERT INTO streamings VALUES (45470,'06/03/22', '06/03/2022',240);
INSERT INTO streamings VALUES (45471, '03/03/2022' , '06/03/2022', 140);
INSERT INTO streamings VALUES (45472, '12/10/19','06/03/2022',380);

-- posts
INSERT INTO posts VALUES (45473,'vamos a estar jugando un PREGUNTAS Y RESPUESTAS DE HSM');
INSERT INTO posts VALUES (45474, 'El Miércoles 2 De Febrero Vuelve #TeLoResumo');
INSERT INTO posts VALUES (45475, 'Compra boletos para el tour del Camino del Héroe');


-- likes
INSERT INTO likes VALUES (1,45467);
INSERT INTO likes VALUES (2,45468);
INSERT INTO likes VALUES (3,45469);

-- CICLO 1: PoblarNoOK 2

-- usuarios
/* No deberia permitir id de un tipo no definido*/
INSERT INTO usuarios VALUES ('45','johan@gmail.com','Juan', '04/03/2010');
-- cuentas
/* No deberia permitir que se inserten filas con atributos NULL con restricción*/
INSERT INTO cuentas VALUES (9001,NULL, '26/08/2017', 0, 1);
-- exclusividades
/* No deberia permitir que se inserten filas con PK's iguales*/
INSERT INTO exclusividades VALUES (1205,1, 'Bronce', 5, NULL, 9001);
-- etapas
/* No deberia permitir que se inserten filas con atributos cuyo tipo no sea el definido*/
INSERT INTO etapas VALUES ('26/01/2022', NULL, 36, 'Miembro', 9001 , '4026' );
-- contenidos
/* No deberia permitir que se inserten filas con Fechas en otros formatos  */
INSERT INTO contenidos VALUES (45467, 'Resumen Next', NULL , NULL, 1, 9001);

-- CICLO 1: PoblarNoOK 3

-- usuarios
/* Correo sin almenos un @*/
INSERT INTO usuarios VALUES (4,'johangmail.com','Juan', '04/03/2010');
-- cuentas
/* La fecha de creacion no deber ser mayor a la del sistema*/
INSERT INTO cuentas VALUES (9004,'Johan', '26/08/2040', 9999, 1);
-- exclusividades
/* El codigo no es en el formato correcto */
INSERT INTO exclusividades VALUES (1205,1, 'Bronce', 8, NULL, 9004);
-- etapas
/* El precio es menor que 0*/
INSERT INTO etapas VALUES ('26/01/2022', NULL, -10, 'Miembro', 9001 , 4028 );
-- contenidos
/*  Fecha de contenido incoherente */
INSERT INTO contenidos VALUES (45476,'ErrorOK', '12/09/1900' , NULL, 1, 9001);


--CICLO 1: XPoblar(Eliminar los datos)

-- likes
DELETE FROM likes;

-- posts
DELETE FROM posts;

--streamings
DELETE FROM streamings;

--videos
DELETE FROM videos;

--contenidos
DELETE FROM contenidos;

--etapas
DELETE FROM etapas;

--labels
DELETE FROM labels;

--exclusividades
DELETE FROM exclusividades;

--suscripciones
DELETE FROM suscripciones;

--cuentas
DELETE FROM cuentas;

--usuarios
DELETE FROM usuarios;

---CICLO 1: Atributos

--Usuarios
ALTER TABLE usuarios ADD (
    CONSTRAINT CK_USUARIOS_CREATEDAT CHECK(createdAt> TO_DATE ('14/05/2005','DD/MM/YYYY'))
);

--Likes
--ninguna

--Cuentas
ALTER TABLE cuentas ADD (
    CONSTRAINT CK_CUENTAS_CREATEDAT CHECK(createdAt> TO_DATE ('14/05/2005','DD/MM/YYYY')),
    CONSTRAINT CK_CUENTAS_SUSCRIBERS CHECK(suscribers>=0)
);

--suscripciones
ALTER TABLE suscripciones ADD (
    CONSTRAINT CK_SUSCRIPCIONES_CREATEDAT CHECK(createdAt> TO_DATE ('14/05/2005','DD/MM/YYYY'))
);

--etapas
ALTER TABLE etapas ADD (
    CONSTRAINT CK_ETAPAS_STARTAT CHECK(startAt> TO_DATE ('14/05/2005','DD/MM/YYYY')),
    CONSTRAINT CK_ETAPAS_ENDAT CHECK(startAt< endAt),
    CONSTRAINT CK_ETAPAS_PRICE CHECK(price>=0),
    CONSTRAINT CK_ETAPAS_STATUS CHECK(status IN ('Activa', 'Terminada', 'Cancelada'))   
);

--exclusividades
ALTER TABLE exclusividades ADD (
    CONSTRAINT CK_EXCLUSIVIDADES_CODE CHECK(code LIKE('EX-%')),
    CONSTRAINT CK_EXCLUSIVIDADES_E_ORDER CHECK(e_order>=0),
    CONSTRAINT CK_EXCLUSIVIDADES_PRICE CHECK(price>=0),
    CONSTRAINT CK_EXCLUSIVIDADES_DURATION CHECK(duration>=1),
    CONSTRAINT CK_EXCLUSIVIDADES_ CHECK(duration<=90)
);   


--contenidos
ALTER TABLE contenidos ADD (
    CONSTRAINT CK_CONTENIDOS_PUBLISHINGDATE CHECK(publishingDate> TO_DATE ('14/05/2005','DD/MM/YYYY'))
    );

--videos
ALTER TABLE videos ADD (
    CONSTRAINT CK_VIDEOS_DURATIONMIN CHECK(duration>0),
    CONSTRAINT CK_VIDEOS_DURATIONMAX CHECK(duration<1380)
);

 
--streamings
ALTER TABLE streamings ADD (
    CONSTRAINT CK_STREAMINGS_PLANNEDDATE CHECK(plannedDate> TO_DATE ('14/05/2005','DD/MM/YYYY')),
    CONSTRAINT CK_STREAMINGS_DURATIONMIN CHECK(duration>0),
    CONSTRAINT CK_STREAMINGS_DURATIONMAX CHECK(duration<1380)
);


--posts
ALTER TABLE posts ADD (
    CONSTRAINT CK_POST_TEXT CHECK(text LIKE('% %') 
    OR text LIKE('% % %')
    OR text LIKE('% % % %') 
    OR text LIKE('% % % % %') 
    OR text LIKE('% % % % % %') 
    OR text LIKE('% % % % % % %') 
    OR text LIKE('% % % % % % % %') 
    OR text LIKE('% % % % % % % % %') 
    OR text LIKE('% % % % % % % % % %'))
);

--labels
ALTER TABLE labels ADD (
    CONSTRAINT CK_LABELS_1 CHECK(label LIKE('%\_%') ESCAPE '\'),
    CONSTRAINT CK_LABELS_2 CHECK(label NOT LIKE('#"%')ESCAPE '\' ),
    CONSTRAINT CK_LABELS_3 CHECK(label NOT LIKE('%\_%\_%')ESCAPE '\')
);

---CICLO 1:Primarias 

--contenidos
ALTER TABLE contenidos ADD (
    CONSTRAINT CK_CONTENIDOS_ID CHECK(id  > 0)
);
-- usuarios
ALTER TABLE usuarios ADD (
    CONSTRAINT CK_USURARIOS_ID CHECK(id  > 0)
);
-- cuentas
ALTER TABLE cuentas ADD (
    CONSTRAINT CK_CUENTAS_ID CHECK(id  > 0)
);
-- suscripciones
ALTER TABLE suscripciones ADD (
    CONSTRAINT CK_SUSCRIPCIONES_ID CHECK(id  > 0)
);

---CICLO1:Unicas

 --usuarios
ALTER TABLE usuarios ADD (
    CONSTRAINT CK_USUARIOS_EMAIL CHECK(email LIKE('%@%.%')),
    CONSTRAINT CK_USUSARIOS_NOTEMAIL CHECK(email NOT LIKE('%@%@%'))
);

--CICLO 1: Foráneas

-- likes
ALTER TABLE likes ADD (
    CONSTRAINT CK_LIKES_U_ID CHECK(Usuarios_id > 0),
    CONSTRAINT CK_LIKES_C_ID CHECK(Contenidos_id > 0)
);

-- contenidos
ALTER TABLE contenidos ADD (
    CONSTRAINT CK_CONTENIDOS_U_ID CHECK(Usuarios_id > 0),
    CONSTRAINT CK_CONTENIDOS_E_ID CHECK(Exclusividades_id > 0)
);

-- videos
ALTER TABLE videos ADD (
    CONSTRAINT CK_VIDEOS_ID CHECK(Contenidos_id > 0)
);
-- streamings
ALTER TABLE streamings ADD (
    CONSTRAINT CK_STREAMINGS_ID CHECK(Contenidos_id > 0)
);

-- posts
ALTER TABLE posts ADD (
    CONSTRAINT CK_POSTS_ID CHECK(Contenidos_id > 0)
);
-- etapas
ALTER TABLE etapas ADD (
    CONSTRAINT CK_ETAPAS_S_ID CHECK(Suscripciones_id > 0),
    CONSTRAINT CK_ETAPAS_E_ID CHECK(Exclusividades_id > 0)
);
-- suscripciones
ALTER TABLE suscripciones ADD (
    CONSTRAINT CK_SUSCRIPCIONES_C_ID CHECK(Cuentas_id > 0),
    CONSTRAINT CK_SUSCRIPCIONES_SUSCRITOA CHECK(SuscritoA > 0)
);
-- cuentas
ALTER TABLE cuentas ADD (
    CONSTRAINT CK_CUENTAS_U_ID CHECK(Usuarios_id > 0)
);
-- labels
ALTER TABLE labels ADD (
    CONSTRAINT CK_LABELS_E_ID CHECK(Exclusividades_id > 0)
);

-- exclusividades
ALTER TABLE exclusividades ADD (
    CONSTRAINT CK_EXCLUSIVIDADES_C_ID CHECK(Cuentas_id > 0)
);


-- CICLO 1: PoblarNoOK (2)
/*
-- usuarios
Correo sin almenos un @
INSERT INTO usuarios VALUES (4,'johangmail.com','Juan', '04/03/2010');

Esta protegido por la restriccion de usuarios EMAILA y EMAILD

-- cuentas
 La fecha de creacion no deber ser mayor a la del sistema
INSERT INTO cuentas VALUES (9004,'Johan', '26/08/2040', 1);

Esta protegido por la restriccion CKECKDATEC

-- exclusividades
El codigo no tiene el formato correcto
INSERT INTO exclusividades VALUES (1205,1, 'Bronce', 8, NULL, 9004);

Esta protegido por la restriccion TCODE

-- etapas
El precio es menor que 0
INSERT INTO etapas VALUES ('26/01/2022', NULL, -10, 'Miembro', 9001 , 4028 );

Esta protegido por PRECIOE

-- contenidos
Fecha de contenido incoherente 
INSERT INTO contenidos VALUES (45476,'ErrorOK', '12/09/1900' , NULL, 1, 9001);

Esta protefido por CHECHDATECO

*/


---Costruccion: consultando

--CICLO 1: consultar
SELECT name, suscribers FROM cuentas
ORDER BY suscribers DESC;


-- CICLO 1: World record Streaming mas largo
SELECT title, duration, description FROM contenidos JOIN streamings ON (id = Contenido_id)
WHERE duration = (SELECT MAX(duration) FROM streamings);




---Nuevamente Poblando 

--Usuarios
insert into usuarios (id, email, name, createdAt) values (1, 'phelder0@furl.net', 'Patrizia Helder', '07/12/2010');
insert into usuarios (id, email, name, createdAt) values (2, 'lmcewen1@drupal.org', 'Lyle McEwen', '25/08/2008');
insert into usuarios (id, email, name, createdAt) values (3, 'mwoodwind2@nytimes.com', 'Murial Woodwind', '25/11/2007');
insert into usuarios (id, email, name, createdAt) values (4, 'mfrancino3@tinypic.com', 'Mauricio Francino', '11/01/2007');
insert into usuarios (id, email, name, createdAt) values (5, 'asimmens4@fotki.com', 'Allissa Simmens', '26/06/2017');
insert into usuarios (id, email, name, createdAt) values (6, 'lboggs5@amazon.com', 'Liana Boggs', '21/04/2007');
insert into usuarios (id, email, name, createdAt) values (7, 'wpeterson6@hp.com', 'Wileen Peterson', '09/10/2014');
insert into usuarios (id, email, name, createdAt) values (8, 'jdempsey7@xrea.com', 'Jemimah Dempsey', '10/11/2021');
insert into usuarios (id, email, name, createdAt) values (9, 'mlowfill8@behance.net', 'Marsh Lowfill', '15/11/2020');
insert into usuarios (id, email, name, createdAt) values (10, 'apeasey9@who.int', 'Alaine Peasey', '27/11/2019');
insert into usuarios (id, email, name, createdAt) values (11, 'canana@wikipedia.org', 'Chelsy Anan', '14/08/2010');
insert into usuarios (id, email, name, createdAt) values (12, 'klazerb@soup.io', 'Kelley Lazer', '09/09/2008');
insert into usuarios (id, email, name, createdAt) values (13, 'mgarryc@redcross.org', 'Mendie Garry', '17/01/2011');
insert into usuarios (id, email, name, createdAt) values (14, 'eclerked@ucoz.com', 'Esdras Clerke', '27/12/2006');
insert into usuarios (id, email, name, createdAt) values (15, 'maucotte@pinterest.com', 'Merrili Aucott', '14/08/2008');
insert into usuarios (id, email, name, createdAt) values (16, 'bgorhamf@cmu.edu', 'Baxie Gorham', '26/07/2020');
insert into usuarios (id, email, name, createdAt) values (17, 'bhakingg@gnu.org', 'Brandie Haking', '04/06/2018');
insert into usuarios (id, email, name, createdAt) values (18, 'gbignoldh@moonfruit.com', 'Gaven Bignold', '06/05/2017');
insert into usuarios (id, email, name, createdAt) values (19, 'bkulleri@github.io', 'Bertine Kuller', '10/04/2010');
insert into usuarios (id, email, name, createdAt) values (20, 'mthackhamj@51.la', 'Mead Thackham', '04/01/2018');

--- cuentas
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (133, 'alocarno0', '30/05/2019', 27857, 1);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (258, 'ftzuker1', '04/03/2018', 97632, 2);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (383, 'ebraunston2', '08/01/2021', 64857, 3);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (508, 'sremmer3', '30/12/2011', 96601, 4);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (633, 'lgerge4', '14/06/2016', 5933, 5);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (758, 'ccappell5', '24/11/2007', 23138, 6);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (883, 'pgrimsley6', '11/04/2014', 97277, 7);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (1008, 'rswindon7', '30/05/2019', 69594, 8);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (1133, 'ccleynman8', '05/01/2015', 5853, 9);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (1258, 'mhebdon9', '22/08/2007', 47347, 10);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (1383, 'jmckimma', '27/02/2007', 31582, 11);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (1508, 'fparmeterb', '19/01/2015', 70957, 12);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (1633, 'cgalloc', '15/03/2012', 2418, 13);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (1758, 'cbrideoked', '01/04/2019', 83223, 14);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (1883, 'coregane', '12/12/2014', 29173, 15);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (2008, 'kandresf', '19/11/2005', 36528, 16);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (2133, 'dweing', '02/08/2019', 85604, 17);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (2258, 'lcatfordh', '17/11/2007', 68361, 18);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (2383, 'fbelamyi', '03/07/2005', 27063, 19);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (2508, 'lkezarj', '01/10/2005', 33036, 20);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (1, 'Coffe TV', '03/07/2005', 27063, 21);
insert into cuentas (id, name, createdAt, suscribers, usuarios_id) values (2, 'Te lo resumo', '01/10/2005', 33036, 22);

-- exclusividades
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-827439', 955, 'Witch Hazel', 856753545, 85, 133);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-522956', 675, 'Chaetomium globosum', 265106392, 57, 258);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-503852', 292, 'Norethindrone Acetate', 545820119, 37, 383);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-263208', 333, 'Abstral', 474518564, 70, 508);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-549368', 172, 'Venlafaxine Hydrochloride', 894627838, 42, 633);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-946751', 914, 'WINRHO', 517275827, 2, 758);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-221459', 571, 'pain relief', 240802562, 61, 883);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-825903', 45, 'Maximum Strength', 802636775, 76, 1008);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-745070', 474, 'Lavender Hand Sanitizer', 234655698, 19, 1133);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-385222', 847, 'BYDUREON', 519844217, 51, 1258);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-085741', 615, 'Metronidazole', 317951798, 6, 1383);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-371094', 22, 'Glucagon', 116339545, 75, 1508);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-125003', 883, 'Laxative', 17654374, 25, 1633);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-590109', 966, 'Isoniazid', 321433042, 67, 1758);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-383236', 617, 'Carvedilol', 452655210, 10, 1883);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-794114', 947, 'Ciclopirox', 748751924, 49, 2008);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-820033', 345, 'Rhus Tox. e fol. 4', 737791153, 14, 2133);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-207507', 456, 'Alprazolam', 300030473, 37, 2258);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-879607', 291, 'Nitroglycerin In Dextrose', 531252159, 23, 2383);
insert into exclusividades (code, e_order, name, price, duration, cuentas_id) values ('EX-268539', 148, 'Caduet', 381766026, 3, 2508);




-- suscripciones
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (223, '05/07/2019', 'nec molestie sed', 133, 2508);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (446, '03/07/2011', 'vitae mattis nibh ligula', 258, 2383);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (669, '20/06/2013', null, 383, 2258);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (892, '17/12/2019', null, 508, 2133);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (1115, '03/10/2014', null, 633, 2008);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (1338, '14/12/2008', 'sit amet', 758, 1883);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (1561, '12/04/2021', 'eget vulputate ut ultrices vel', 883, 1758);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (1784, '20/05/2021', 'leo maecenas pulvinar', 1008, 1633);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (2007, '04/11/2012', 'elit ac', 1133, 1508);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (2230, '08/10/2019', null, 1258, 1383);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (2453, '25/04/2018', null, 1383, 1258);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (2676, '17/04/2010', 'ut erat curabitur', 1508, 1133);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (2899, '17/01/2018', 'ut erat id', 1633, 1008);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (3122, '28/03/2014', 'nisi volutpat eleifend donec ut dolor', 1758, 883);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (3345, '01/01/2009', 'sapien non mi', 1883, 758);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (3568, '12/02/2019', 'lacus at velit vivamus vel', 2008, 633);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (3791, '24/07/2021', null, 2133, 508);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (4014, '25/10/2007', 'luctus et', 2258, 383);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (4237, '20/07/2013', 'pellentesque volutpat dui maecenas tristique', 2383, 258);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values (4460, '12/06/2015', 'vel accumsan tellus nisi eu', 2508, 133);


-- etapas
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('28/07/2010', null, 614483351, 'Terminada', 133, 223);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('18/11/2008', '09/06/2021', 267433811, 'Terminada', 258, 446);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('02/12/2013', '02/06/2016', 94064248, 'Terminada', 383, 669);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('08/12/2007', '24/06/2021', 295718347, 'Cancelada', 508, 892);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('20/08/2008', null, 815069414, 'Terminada', 633, 1115);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('15/02/2012', '26/02/2021', 511203890, 'Terminada', 758, 1338);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('04/01/2006', '28/09/2017', 824847852, 'Activa', 883, 1561);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('04/01/2010', null, 952591658, 'Activa', 1008, 1784);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('26/03/2008', '06/02/2020', 696215544, 'Activa', 1133, 2007);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('25/02/2014', '30/05/2020', 741785490, 'Cancelada', 1258, 2230);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('16/09/2005', null, 354905887, 'Activa', 1383, 2453);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('02/06/2005', '20/06/2019', 501101886, 'Terminada', 1508, 2676);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('20/12/2013', '01/01/2017', 88073795, 'Activa', 1633, 2899);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('09/02/2006', '23/01/2018', 221528393, 'Cancelada', 1758, 3122);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('15/01/2015', null, 308262423, 'Cancelada', 1883, 3345);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('21/02/2013', '14/01/2019', 106019314, 'Cancelada', 2008, 3568);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('24/06/2006', '07/04/2016', 815675862, 'Cancelada', 2133, 3791);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('09/06/2011', '21/12/2016', 618253953, 'Cancelada', 2258, 4014);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('21/03/2007', '20/10/2015', 768859146, 'Activa', 2383, 4237);
insert into etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('21/03/2006', null, 110984277, 'Activa', 2508, 4460);


-- contenido
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (3477, 'sed', '15/05/2008', 'bibendum felis', 1, 133);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (7037, 'est', '02/01/2020', null, 2, 258);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (10597, 'id', '10/02/2007', 'in hac', 3, 383);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (14157, 'scelerisque', '16/11/2021', 'urna ut tellus', 4, 508);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (17717, 'platea', '22/06/2013', null, 5, 633);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (21277, 'in', '22/05/2019', null, 6, 758);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (24837, 'sollicitudin vitae', '17/10/2006', 'est et tempus', 7, 883);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (28397, 'interdum mauris', '16/04/2015', 'augue vel accumsan', 8, 1008);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (31957, 'vestibulum quam', '31/03/2016', 'posuere nonummy integer', 9, 1133);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (35517, 'elit', '17/08/2011', null, 10, 1258);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (39077, 'nunc', '08/10/2009', 'lectus pellentesque at', 11, 1383);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (42637, 'odio', '09/01/2013', 'libero quis', 12, 1508);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (46197, 'morbi vestibulum', '16/09/2016', 'eget eleifend luctus', 13, 1633);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (49757, 'odio consequat', '27/07/2016', 'eget tincidunt eget', 14, 1758);
insert into contenidos (id, title, publishingDate, description, usuarios_id, exclusividades_id) values (53317, 'mus etiam', '07/04/2009', 'etiam faucibus', 15, 1883);

-- videos
insert into videos (contenidos_id, duration) values (3477, 168);
insert into videos (contenidos_id, duration) values (7037, 1296);
insert into videos (contenidos_id, duration) values (10597, 354);
insert into videos (contenidos_id, duration) values (14157, 487);
insert into videos (contenidos_id, duration) values (17717, 166);

--streamings
insert into streamings (contenidos_id, plannedDate, actualDate, duration) values (21277, '28/12/2006', '03/08/2020', 386);
insert into streamings (contenidos_id, plannedDate, actualDate, duration) values (24837, '29/12/2006', null, 705);
insert into streamings (contenidos_id, plannedDate, actualDate, duration) values (28397, '16/03/2007', '13/01/2019', 1123);
insert into streamings (contenidos_id, plannedDate, actualDate, duration) values (31957, '10/05/2012', '25/04/2020', 952);
insert into streamings (contenidos_id, plannedDate, actualDate, duration) values (35517, '28/08/2007', null, 599);

--posts
insert into posts (contenidos_id, text) values (39077, 'ullamcorper augue a suscipit nulla elit');
insert into posts (contenidos_id, text) values (42637, 'sit amet diam in magna');
insert into posts (contenidos_id, text) values (46197, 'lobortis ligula sit amet');
insert into posts (contenidos_id, text) values (49757, 'phasellus id sapien in sapien iaculis congue');
insert into posts (contenidos_id, text) values (53317, 'aliquam lacus');

--labels
insert into labels (exclusividades_id, label) values (133, '733_vlb');
insert into labels (exclusividades_id, label) values (258, '408_eca');
insert into labels (exclusividades_id, label) values (383, '028_grt');
insert into labels (exclusividades_id, label) values (508, '033_roj');
insert into labels (exclusividades_id, label) values (633, '321_vwo');
insert into labels (exclusividades_id, label) values (758, '333_tyl');
insert into labels (exclusividades_id, label) values (883, '519_rlq');
insert into labels (exclusividades_id, label) values (1008, '979_xgq');
insert into labels (exclusividades_id, label) values (1133, '178_qqy');
insert into labels (exclusividades_id, label) values (1258, '660_uqk');
insert into labels (exclusividades_id, label) values (1383, '252_xnf');
insert into labels (exclusividades_id, label) values (1508, '314_yfn');
insert into labels (exclusividades_id, label) values (1633, '008_cwz');
insert into labels (exclusividades_id, label) values (1758, '425_ihf');
insert into labels (exclusividades_id, label) values (1883, '280_qdn');
insert into labels (exclusividades_id, label) values (2008, '829_jev');
insert into labels (exclusividades_id, label) values (2133, '813_ctu');
insert into labels (exclusividades_id, label) values (2258, '749_prz');
insert into labels (exclusividades_id, label) values (2383, '447_utp');
insert into labels (exclusividades_id, label) values (2508, '817_dfx');

--likes
insert into likes (usuarios_id, contenidos_id) values (1, 3477);
insert into likes (usuarios_id, contenidos_id) values (2, 7037);
insert into likes (usuarios_id, contenidos_id) values (3, 10597);
insert into likes (usuarios_id, contenidos_id) values (4, 14157);
insert into likes (usuarios_id, contenidos_id) values (5, 17717);
insert into likes (usuarios_id, contenidos_id) values (6, 21277);
insert into likes (usuarios_id, contenidos_id) values (7, 24837);
insert into likes (usuarios_id, contenidos_id) values (8, 28397);
insert into likes (usuarios_id, contenidos_id) values (9, 31957);
insert into likes (usuarios_id, contenidos_id) values (10, 35517);
insert into likes (usuarios_id, contenidos_id) values (11, 39077);
insert into likes (usuarios_id, contenidos_id) values (12, 42637);
insert into likes (usuarios_id, contenidos_id) values (13, 46197);
insert into likes (usuarios_id, contenidos_id) values (14, 49757);
insert into likes (usuarios_id, contenidos_id) values (15, 53317);
--------------------
 
--Ciclo 1: CRUD: Mantener suscripción

-- Tuplas
/* ALTER TABLE suscripciones ADD (
    CONSTRAINT CK_SUSCRIPCIONES_CREATEDAT CHECK(createdAt> TO_DATE ('14/05/2005','DD/MM/YYYY'))
);

ALTER TABLE suscripciones ADD (
    CONSTRAINT CK_SUSCRIPCIONES_C_ID CHECK(Cuentas_id > 0),
    CONSTRAINT CK_SUSCRIPCIONES_SUSCRITOA CHECK(SuscritoA > 0)
);

ALTER TABLE etapas ADD (
    CONSTRAINT CK_ETAPAS_STARTAT CHECK(startAt> TO_DATE ('14/05/2005','DD/MM/YYYY')),
    CONSTRAINT CK_ETAPAS_STARTAT CHECK(startAt< endAt),
    CONSTRAINT CK_ETAPAS_PRICE CHECK(price>=0),
    CONSTRAINT CK_ETAPAS_STATUS CHECK(status IN ('Activa', 'Terminada', 'Cancelada'))   
);

ALTER TABLE etapas ADD (
    CONSTRAINT CK_ETAPAS_S_ID CHECK(Suscripciones_id > 0),
    CONSTRAINT CK_ETAPAS_E_ID CHECK(Exclusividades_id > 0)
);
*/

-- TuplasOk
INSERT INTO suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values ( 4468, '24/03/2022', 'nec molestie sed', 133, 2508);
INSERT INTO  etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('21/03/2006', null, 110984277, 'Activa', 2508, 4460);
-- TuplasNoOK
-- Fecha incorrecta
INSERT INTO suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values ( 4468, '24/03/2002', 'nec molestie sed', 133, 2508);
-- Fecha, precio, status incorrectos
INSERT INTO  etapas (startAt, endAt, price, status, exclusividades_id, suscripciones_id) values ('21/03/2006', '21/03/2005', -10 , 'eref', 2508, 4460);

-- Acciones

-- AccionesOk

--Disparadores

-- the id is generated
CREATE SEQUENCE SUSCRPITION_SEQUENCE
    MINVALUE 1
    START WITH 1;
    
CREATE OR REPLACE TRIGGER TR_SUSCRIPCIONES_BI_ID
    BEFORE INSERT ON SUSCRIPCIONES
    FOR EACH ROW
BEGIN
    SELECT SUSCRPITION_SEQUENCE.NEXTVAL INTO :NEW.ID FROM DUAL;  
END;
/
--the createdAt date is auto generated
CREATE OR REPLACE TRIGGER TR_SUSCRIPCIONES_BI_CREATEDATE 
    BEFORE INSERT ON SUSCRIPCIONES
    FOR EACH ROW 
    BEGIN
   :NEW.CREATEDAT := CURRENT_DATE; 
END;
/
-- the stage corresponding to the free level of exclusivity is created and assigned
/*CREATE OR REPLACE TRIGGER TR_SUSCRIPCIONES_AI_STAGE
    AFTER INSERT
    ON suscripciones
    FOR EACH ROW 
DECLARE
    exclusividades etapas.exclusividades_id%TYPE; 
BEGIN
END;
*/
-- the free level of exclusivity must be well defined
 
-- just the detail and the stage could be updated
CREATE OR REPLACE TRIGGER TR_SUSCRIPCIONES_BU 
    BEFORE UPDATE 
    OF  ID, CREATEDAT, CUENTAS_ID, SUSCRITOA
    ON SUSCRIPCIONES
    FOR EACH ROW 
BEGIN
    IF :NEW.ID <> :OLD.ID
    OR :NEW.CREATEDAT <> :OLD.CREATEDAT
    OR :NEW.CUENTAS_ID <> :OLD.CUENTAS_ID
    OR :NEW.SUSCRITOA <> :OLD.SUSCRITOA
    THEN 
    RAISE_APPLICATION_ERROR(-20001, 'No es posible actualizar');
    END IF;
END;
/
CREATE OR REPLACE TRIGGER TR_ETAPAS_BU 
    BEFORE UPDATE 
    OF  SUSCRIPCIONES_ID
    ON ETAPAS
    FOR EACH ROW 
BEGIN
    IF :NEW.SUSCRIPCIONES_ID <> :OLD.SUSCRIPCIONES_ID
    THEN 
    RAISE_APPLICATION_ERROR(-20002, 'No es posible actualizar');
    END IF;
END;
/
-- Subscriptions could be deleted during the first two days after created

CREATE OR REPLACE TRIGGER TR_SUSCRIPCIONES_BD
    BEFORE DELETE ON SUSCRIPCIONES
    FOR EACH ROW
BEGIN
    IF SYSDATE - :OLD.CREATEDAT > 2 THEN  
    RAISE_APPLICATION_ERROR(-20003, 'No es posible eliminar, ya pasaron los dos dias habilitados para la operación');
    END IF;
END;
/
--DisparadoresOK--
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values ( '', '', 'nec molestie sed', 133, 2508);
insert into suscripciones (id, createdAt, detail, cuentas_id, suscritoA) values ('', '', 'vitae mattis nibh ligula', 258, 2383);
UPDATE suscripciones SET detail = 'Prueba Disparadores' WHERE id = 2;
DELETE FROM suscripciones WHERE id = 1;  -- Subscriptions could be deleted during the first two days after created
 
 ---DisparadoresNoOK--  
UPDATE suscripciones SET createdAt = '23/03/2022' WHERE id = 2; -- Solo se puede actualizar el detalle (detail) de una tupla
UPDATE suscripciones SET cuentas_id = 2899 WHERE id = 2;

--XDisparadores
DROP SEQUENCE suscrpition_sequence;
DROP TRIGGER TR_SUSCRIPCIONES_BI_ID;
DROP TRIGGER TR_SUSCRIPCIONES_BI_CREATEDATE;
DROP TRIGGER TR_SUSCRIPCIONES_BU;
DROP TRIGGER TR_ETAPAS_BU;
DROP TRIGGER TR_SUSCRIPCIONES_BD;

-- Consultas
-- Las suscripciones con etapas más caras.
SELECT price, suscritoA
FROM suscripciones JOIN etapas ON(id = suscripciones_id)
ORDER BY price DESC;

--Ciclo 1: CRUD: Mantener usuario

-- Tuplas

/* 

ALTER TABLE usuarios ADD (
    CONSTRAINT CK_USURARIOS_ID CHECK(id  > 0)
);

ALTER TABLE usuarios ADD (
    CONSTRAINT CK_USUARIOS_CREATEDAT CHECK(createdAt> TO_DATE ('14/05/2005','DD/MM/YYYY'))
);

ALTER TABLE usuarios ADD (
    CONSTRAINT CK_USUARIOS_EMAIL CHECK(email LIKE('%@%.%')),
    CONSTRAINT CK_USUSARIOS_NOTEMAIL CHECK(email NOT LIKE('%@%@%')) -- El correo deber ser bien definido.
);

*/

-- TuplasOk
insert into usuarios (id, email, name, createdAt) values (21, 'andresC@github.io', 'Bertine Kuller', '27/01/2019');
insert into usuarios (id, email, name, createdAt) values (22, 'MatyO@51.la', 'Mead Thackham', '26/04/2017');

-- TuplasNoOk

insert into usuarios (id, email, name, createdAt) values (23, 'andrfesC@gi@thub.io', 'Bertine Kuller', '27/02/2019'); -- Correo con formato incorrecto
insert into usuarios (id, email, name, createdAt) values (24, 'MatyfO@51.la', 'Mead Thackham', '26/04/2004'); -- Fecha de creación incorrecta

-- Acciones
-- El usuario puede incluir nuevos contenidos que les gusten; pero, no puede ni modificarlos ni eliminarlos.

/*ALTER TABLE likes ADD (CONSTRAINT FK_LIKES_USUARIOS_ID FOREIGN KEY(usuarios_id) REFERENCES usuarios(id) 
ON DELETE RESTRICT);*/
                                   
-- AccionesOk

-- Disparadores
/
--  El id es autogenerado.
CREATE SEQUENCE usuarios_sequence
    MINVALUE 1
    START WITH 1;

CREATE OR REPLACE TRIGGER TR_USUARIOS_BI_ID
    BEFORE INSERT ON usuarios
    FOR EACH ROW
BEGIN
    SELECT usuarios_sequence.nextval INTO :NEW.id FROM dual;  
END;
/
-- La fecha de creación es auto generada.
CREATE OR REPLACE TRIGGER TR_USUARIOS_BI_CREATEDATE 
    BEFORE INSERT ON usuarios
    FOR EACH ROW 
    BEGIN   
    IF :NEW.createdAt IS NULL THEN
     :NEW.createdAt := CURRENT_DATE; 
    END IF;
END;
/


-- Solo se puede actualizar el nombre del usuario.
CREATE OR REPLACE TRIGGER TR_USUARIOS_BU 
    BEFORE UPDATE 
    OF  id, createdAt
    ON suscripciones
    FOR EACH ROW 
BEGIN
    IF :NEW.id <> :OLD.id
    OR :NEW.createdAt <> :OLD.createdAt
    THEN 
    RAISE_APPLICATION_ERROR(-20004, 'No es posible actualizar el usuario');
    END IF;
END;
/
-- El usuario puede incluir nuevos contenidos que les gusten; pero, no puede ni modificarlos ni eliminarlos.

CREATE OR REPLACE TRIGGER TR_LIKES_BD
    BEFORE DELETE ON likes
    FOR EACH ROW
BEGIN
    RAISE_APPLICATION_ERROR(-20005, 'No es posible eliminar ');
END;
/
CREATE OR REPLACE TRIGGER TR_LIKES_BU
    BEFORE UPDATE ON likes
    FOR EACH ROW
BEGIN
    RAISE_APPLICATION_ERROR(-20006, 'No es posible modificar ');
END;
/
-- Los usuarios no se pueden eliminar.
CREATE OR REPLACE TRIGGER TR_USUARIOS_BD
    BEFORE DELETE ON usuarios
    FOR EACH ROW
BEGIN
    RAISE_APPLICATION_ERROR(-20007, 'No es posible eliminar ');
END;
/
--DisparadoresOK
insert into usuarios (id, email, name, createdAt) values ('', 'CamiloOñate@github.io', 'Bertine Kuller', '');
insert into usuarios (id, email, name, createdAt) values ('', 'MateooOlaya@51.la', 'Mead Thackham', '');
UPDATE usuarios SET name = 'Camilo XP' WHERE id = 1;

--DisparadoresNoOk
DELETE FROM likes WHERE contenidos_id = 1; -- No se pueden eliminar los likes
UPDATE likes SET usuarios_id = 2 WHERE usuarios_id = 1; -- No se pueden modificar los likes
DELETE FROM usuarios WHERE id = 1; --Los usuarios no se pueden eliminar.

--XDisparadores
DROP SEQUENCE usuarios_sequence;
DROP TRIGGER TR_USUARIOS_BI_ID;
DROP TRIGGER TR_USUARIOS_BI_CREATEDATE;
DROP TRIGGER TR_LIKES_BD;
DROP TRIGGER TR_LIKES_BU;
DROP TRIGGER TR_USUARIOS_BU;
DROP TRIGGER TR_USUARIOS_BD;

-- Consultas
SELECT usuarios.id, COUNT(contenidos.id)
FROM usuarios JOIN contenidos ON (usuarios.id = contenidos.usuarios_id )
GROUP BY usuarios_id;

---- Xtablas
-- likes
DROP TABLE likes;

-- posts
DROP TABLE posts;

--streamings
DROP TABLE streamings;

--videos
DROP TABLE videos;

--contenidos
DROP TABLE contenidos;

--etapas
DROP TABLE etapas;

--labels
DROP TABLE labels;

--exclusividades
DROP TABLE exclusividades;

--suscripciones
DROP TABLE suscripciones;

--cuentas
DROP TABLE cuentas;

--usuarios
DROP TABLE usuarios;


-----------------------------------------------------------------------------------------------------------------------
----LABORATORIO 5

--A. Extendiendo. Usuarios
-- 1. Consulte la información que actualmente está en la tabla
SELECT * FROM mbdaa01.DATA;
-- 2. Inclúyanse como usuarios
INSERT INTO mbdaa01.DATA (ID, NAME, EMAIL, NDAY) VALUES ('2604', 'Mateo Olaya', 'mateo.olaya@mail.escuelaing.edu.co', '22');
INSERT INTO mbdaa01.DATA(ID,NAME, EMAIL, NDAY) VALUES ('2701', 'Andrés Oñate', 'andres.onate@mail.escueling.edu.co', '27');
-- 3. Traten de modificarse o borrarse. ¿qué pasa?
UPDATE mbdaa01.DATA SET NAME = 'Andrés Oñate Quimbayo' WHERE ID = '2701';
DELETE FROM  mbdaa01.DATE WHERE ID = '2701';
-- 4. Escriban la instrucción necesaria para otorgar los permisos que actualmente tiene esatabla. ¿quién la escribió? Word
-- 5. Escriban las instrucciones necesarias para importar los datos de esa tabla a su base de datos. Todos los usuarios son del mes de abril del 2022.
INSERT INTO usuarios SELECT TO_NUMBER(ID), EMAIL, NAME, TO_DATE (CONCAT(NDAY,'/04/2022'),'DD/MM/YYYY') FROM mbdaa01.DATA
                     WHERE EMAIL LIKE('%@%.%') AND ID IS NOT NULL 
                     AND (SELECT COUNT(*) FROM mbdaa01.DATA compae 
                          WHERE compae.email = mbdaa01.DATA.email) = 1
                     AND (SELECT COUNT(*) FROM mbdaa01.DATA compai 
                          WHERE compai.id = mbdaa01.DATA.id) = 1;
                     
-- C. Modelo físico. Componentes.    

-- CRUDE

CREATE OR REPLACE PACKAGE PC_SUBSCRIPTIONS IS
    PROCEDURE AD_SUBSCRIPTION (detail IN VARCHAR, cuentaid IN NUMBER, suscritoA IN NUMBER);   
    PROCEDURE MO_SUBSCRIPTION (xsuscription IN NUMBER, xdetail IN VARCHAR);  
    PROCEDURE MO_STAGE(xendAt IN DATE, xprice IN NUMBER, xstatus IN VARCHAR,xsuscription IN NUMBER, xstartAt IN DATE);
    PROCEDURE DEL_SUBSCRIPTION(xsuscription IN NUMBER);
    
    FUNCTION CO_SUBSCRIPTION(xcuenta IN NUMBER) RETURN SYS_REFCURSOR;
    FUNCTION CO_MOST_EXPENSIVE RETURN SYS_REFCURSOR;
    FUNCTION CO_MAX_SUBS_BYDAY RETURN SYS_REFCURSOR;
END PC_SUBSCRIPTIONS;
/                   
     
--CRUDI
CREATE OR REPLACE PACKAGE BODY PC_SUBSCRIPTIONS IS
    PROCEDURE AD_SUBSCRIPTION(detail IN VARCHAR, cuentaid IN NUMBER, suscritoA NUMBER) IS
    BEGIN
        INSERT INTO suscripciones (id, createdAt, detail, cuentas_id, suscritoA) VALUES ( '', '', detail, cuentaid, suscritoA);
        COMMIT;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE_APPLICATION_ERROR(-20017, SQLERRM);
    END;
    
    PROCEDURE MO_SUBSCRIPTION (xsuscription IN NUMBER, xdetail IN VARCHAR) IS
    BEGIN
        UPDATE suscripciones SET detail = xdetail WHERE ID = xsuscription;
        COMMIT;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE_APPLICATION_ERROR(-20018, SQLERRM);
    END;  
    
    PROCEDURE MO_STAGE(xendAt IN DATE, xprice IN NUMBER, xstatus IN VARCHAR,xsuscription IN NUMBER, xstartAt IN DATE) IS
    BEGIN
        UPDATE etapas SET endAt = xendAt, price = xprice, status = xstatus 
        WHERE suscripciones_id = xsuscription AND startAt = xstartAt;
        COMMIT;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE_APPLICATION_ERROR(-20019, SQLERRM);
    END; 
    
    PROCEDURE DEL_SUBSCRIPTION(xsuscription IN NUMBER) IS
    BEGIN
        DELETE FROM suscripciones WHERE ID = xsuscription;
        COMMIT;
        EXCEPTION
            WHEN OTHERS THEN
                ROLLBACK;
                RAISE_APPLICATION_ERROR(-20020, SQLERRM);
    END; 
    
    FUNCTION CO_SUBSCRIPTION(xcuenta IN NUMBER) RETURN SYS_REFCURSOR IS CO_SUSB SYS_REFCURSOR;
    BEGIN
        OPEN CO_SUSB FOR
            SELECT cuentas.name, suscripciones.detail
            FROM suscripciones JOIN cuentas ON (cuentas.id = suscripciones.suscritoA)
            WHERE suscripciones.cuentas_id = xcuenta;
        RETURN CO_SUSB;
    END; 
    
    FUNCTION CO_MOST_EXPENSIVE RETURN SYS_REFCURSOR IS CO_EXP SYS_REFCURSOR;
    BEGIN
        OPEN CO_EXP FOR
            SELECT etapas.price, cuentas.name, suscripciones.detail
            FROM suscripciones JOIN etapas ON (suscripciones.id = etapas.suscripciones_id)
                               JOIN cuentas ON (cuentas.id = suscripciones.suscritoA)
            ORDER BY price DESC;
        RETURN CO_EXP;
    END; 
    
    FUNCTION CO_MAX_SUBS_BYDAY RETURN SYS_REFCURSOR IS CO_MSUBSDAY SYS_REFCURSOR;
    BEGIN
        OPEN CO_MSUBSDAY FOR
            SELECT cuentas.id, cuentas.suscribers
            FROM cuentas
            ORDER BY suscribers DESC;
        RETURN CO_MSUBSDAY;
    END;  
END PC_SUBSCRIPTIONS;
/                   

--XCRUD
DROP PACKAGE PC_SUBSCRIPTIONS;


-- CRUDOK
BEGIN
    PC_SUBSCRIPTIONS.AD_SUBSCRIPTION('Suscripción de prueba', 1,2);
END;

BEGIN
    PC_SUBSCRIPTIONS.MO_SUBSCRIPTION (2, 'Prueba de CRUD MO');
END;

BEGIN
    PC_SUBSCRIPTIONS.MO_STAGE('21/05/2022', 22300, 'Activa' , 1, '28/07/10');
END;                    
                     
BEGIN
    PC_SUBSCRIPTIONS.DEL_SUBSCRIPTION(22);
END;                    
    
VARIABLE subs REFCURSOR;
EXECUTE :subs :=  PC_SUBSCRIPTIONS.CO_SUBSCRIPTION(1);
PRINT :subs;

VARIABLE mostExpensive REFCURSOR;
EXECUTE :mostExpensive :=  PC_SUBSCRIPTIONS.CO_MOST_EXPENSIVE();
PRINT :mostExpensive;

VARIABLE maxSubsbyday REFCURSOR;
EXECUTE :maxSubsbyday :=  PC_SUBSCRIPTIONS.CO_MAX_SUBS_BYDAY();
PRINT :maxSubsbyday;

--CRUDNoOk
BEGIN
    PC_SUBSCRIPTIONS.AD_SUBSCRIPTION('Suscripción de prueba', 0,2); --La cuenta no existe
END;

BEGIN
    PC_SUBSCRIPTIONS.MO_SUBSCRIPTION (999, 'Prueba de CRUD MO'); -- La subscripción no exite
END;

BEGIN
    PC_SUBSCRIPTIONS.MO_STAGE('21/05/2022', 22300, 'status incorrecto' , 1, '28/07/10');
END; 

---- D. Modelo físico. Seguridad.
/
--ActoresE
CREATE OR REPLACE PACKAGE PA_USER IS
    PROCEDURE AD_SUBSCRIPTION (detail IN VARCHAR, cuentaid IN NUMBER, suscritoA IN NUMBER);   
    PROCEDURE MO_SUBSCRIPTION (xsuscription IN NUMBER, xdetail IN VARCHAR);  
    PROCEDURE MO_STAGE(xendAt IN DATE, xprice IN NUMBER, xstatus IN VARCHAR,xsuscription IN NUMBER, xstartAt IN DATE);
    PROCEDURE DEL_SUBSCRIPTION(xsuscription IN NUMBER); 
    FUNCTION CO_SUBSCRIPTION(xcuenta IN NUMBER) RETURN SYS_REFCURSOR;
END PA_USER;
/
CREATE OR REPLACE PACKAGE PA_EXPERIENCE_A IS
    FUNCTION CO_MAX_SUBS_BYDAY RETURN SYS_REFCURSOR;
END PA_EXPERIENCE_A;
/
--ActoresI

CREATE OR REPLACE PACKAGE BODY PA_USER IS
    PROCEDURE AD_SUBSCRIPTION(detail IN VARCHAR, cuentaid IN NUMBER, suscritoA NUMBER) IS
    BEGIN
        PC_SUBSCRIPTIONS.AD_SUBSCRIPTION(detail,cuentaid,suscritoA);
    END;
    
    PROCEDURE MO_SUBSCRIPTION (xsuscription IN NUMBER, xdetail IN VARCHAR) IS
    BEGIN
        PC_SUBSCRIPTIONS.MO_SUBSCRIPTION(xsuscription,xdetail);
    END;  
    
    PROCEDURE MO_STAGE(xendAt IN DATE, xprice IN NUMBER, xstatus IN VARCHAR,xsuscription IN NUMBER, xstartAt IN DATE) IS
    BEGIN
        PC_SUBSCRIPTIONS.MO_STAGE(xendAt, xprice, xstatus,xsuscription, xstartAt);
    END; 
    
    PROCEDURE DEL_SUBSCRIPTION(xsuscription IN NUMBER) IS
    BEGIN
        PC_SUBSCRIPTIONS.DEL_SUBSCRIPTION(xsuscription);
    END; 
    
    FUNCTION CO_SUBSCRIPTION(xcuenta IN NUMBER) RETURN SYS_REFCURSOR IS CO_SUSB SYS_REFCURSOR;
    BEGIN
        CO_SUSB := PC_SUBSCRIPTIONS.CO_SUBSCRIPTION(xcuenta);
        RETURN CO_SUSB;
    END;      
END PA_USER;
/
CREATE OR REPLACE PACKAGE BODY PA_EXPERIENCE_A IS   
    FUNCTION CO_MAX_SUBS_BYDAY RETURN SYS_REFCURSOR IS CO_MSUBSDAY SYS_REFCURSOR;
    BEGIN
        CO_MSUBSDAY:=PC_SUBSCRIPTIONS.CO_MAX_SUBS_BYDAY();
        RETURN CO_MSUBSDAY;
    END;      
END PA_EXPERIENCE_A;
/

--- 2. Creen el rol de usuario, otorguen los permisos correspondientes a ese rol.

--Seguridad
CREATE ROLE USUARIO;
GRANT EXECUTE ON PA_USER TO USUARIO;

GRANT USUARIO TO bd1000046782; -- Juan Felipe
GRANT USUARIO TO bd1000046162;

CREATE ROLE EXPERIENCEANALYST;
GRANT EXECUTE ON PA_EXPERIENCE_A TO EXPERIENCEANALYST;

GRANT EXPERIENCEANALYST TO bd1000046782;
GRANT EXPERIENCEANALYST TO bd1000046162;

--XSeguridad
DROP ROLE EXPERIENCEANALYST;
DROP ROLE USUARIO;

--SeguridadOk
VARIABLE consult1 REFCURSOR;
EXECUTE :consult1 := PA_USER.CO_SUBSCRIPTION(1);
PRINT :consult1;

EXECUTE PA_USER.AD_SUBSCRIPTION('Prueba Seguridad 0K', 2,1);

EXECUTE PA_USER.MO_STAGE('21/05/2022', 22300, 'Cancelada' , 1, '28/07/10');

EXECUTE PA_USER.MO_SUBSCRIPTION (11, 'Prueba Seguridad Ok');

VARIABLE consult2 REFCURSOR;
EXECUTE :consult2 := PA_EXPERIENCE_A.CO_MAX_SUBS_BYDAY();
PRINT :consult2;

--SeguridadNoOk
EXECUTE PA_USER.AD_SUBSCRIPTION('Prueba Seguridad No0K', 99,78); -- La cuentas que se pasan por parametro no existen
-- La suscripción no existe
VARIABLE consult3 REFCURSOR; 
EXECUTE :consult3 := PA_USER.CO_SUBSCRIPTION(99);
PRINT :consult3;    
--La suscripción a modificar no existe
EXECUTE PA_USER.MO_SUBSCRIPTION (999, 'Prueba Seguridad No Ok');


-- Pruebas

-- Steven consulta las suscripciones que tiene en su cuenta
VARIABLE consulta1 REFCURSOR;
EXECUTE :consulta1 := PA_USER.CO_SUBSCRIPTION(3);
PRINT :consulta1;

-- No recococe la ultima  suscripción, asi que decide elimimarla
BEGIN
    PC_SUBSCRIPTIONS.DEL_SUBSCRIPTION(24);
END;   

-- Quiere Modificar el detalle de la suscripción a la cuenta CoffeTV
BEGIN
    PC_SUBSCRIPTIONS.MO_SUBSCRIPTION (2, 'Streaming y peliculas');
END;
-- Consulta de nuevo la suscripción
VARIABLE consulta4 REFCURSOR;
EXECUTE :consulta4 := PA_USER.CO_SUBSCRIPTION(3);
PRINT :consulta4;

-- Como analista de expericiencia en Youtube, consulta las cuentas con más suscripciones por dia para realizar un informe
VARIABLE maxSubsbyday REFCURSOR;
EXECUTE :maxSubsbyday :=  PC_SUBSCRIPTIONS.CO_MAX_SUBS_BYDAY();
PRINT :maxSubsbyday;